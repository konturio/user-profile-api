--- # Time-stamp: <2022-09-15 21:25:57>

name: 10 Manual Deployment

'on':
  workflow_dispatch:
    inputs:
      deployment_target:
        description: Deployment targets (choose one)
        required: true
        default: deploy-dev
        type: choice
        options:
          - deploy-spi-plugin-dev-and-test
          - deploy-spi-plugin-prod
      git_ref:
        description: Git ref (optional) # The branch, tag or SHA to checkout
        required: false

jobs:
  helper:
    uses: ./.github/workflows/migration-helper01.yml
  deploy:
    name: '${{ github.event.inputs.deployment_target }}'
    runs-on: ubuntu-latest
    needs: helper
    steps:
      - name: Cloning repository (HEAD)
        uses: actions/checkout@v3
        if: github.event.inputs.git_ref == ''
      - name: 'Cloning repository (${{ github.event.inputs.git_ref }})'
        uses: actions/checkout@v3
        if: github.event.inputs.git_ref != ''
        with:
          ref: '${{ github.event.inputs.git_ref }}'

      - name: Extracting metadata from a cloned repository
        id: get-cloned
        run: |-
          echo "::set-output name=SHA::$(git log -1 --format='%H')"
          echo "::set-output name=REF::$(git symbolic-ref HEAD 2>/dev/null)"

      - name: Download artifact(s)
        id: download-artifact
        uses: konturio/action-download-artifact@v8
        with:
          workflow: main.yml
          workflow_conclusion: success
          commit: '${{steps.get-cloned.outputs.SHA}}'
          name: 'user-profile-api-${{needs.helper.outputs.CI_COMMIT_REF_SLUG}}'

      - name: deploy-spi-plugin-dev-and-test
        if: "'deploy-spi-plugin-dev-and-test' == github.event.inputs.deployment_target"
        env:
          METADATA_FILE_NAME: keycloak01-artifacts.txt
          SOURCE_JAR_PATH: keycloak-user-spi/build/libs/keycloak-user-spi.jar
          AWS_ACCESS_KEY_ID: '${{ secrets.AWS_ACCESS_KEY_ID }}'
          AWS_DEFAULT_REGION: '${{ secrets.AWS_DEFAULT_REGION }}'
          AWS_SECRET_ACCESS_KEY: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
        run: |-
          echo 'source file:'
          ls -l $SOURCE_JAR_PATH
          SHA=$(sha256sum $SOURCE_JAR_PATH | awk '{print $1}')
          echo 'SHA='$SHA
          DATE=$(date -ur $SOURCE_JAR_PATH "+%Y%m%d%H%M.%S")
          sed -i 's!sha256!'$SHA'!g' keycloak-user-spi/$METADATA_FILE_NAME
          sed -i 's!datetime!'$DATE'!g' keycloak-user-spi/$METADATA_FILE_NAME
          aws s3 cp keycloak-user-spi/$METADATA_FILE_NAME s3://user-profile-service-locker01/DEV/$METADATA_FILE_NAME --sse
          aws s3 cp keycloak-user-spi/$METADATA_FILE_NAME s3://user-profile-service-locker01/TEST/$METADATA_FILE_NAME --sse
          aws s3 cp --content-type='text/plain' $SOURCE_JAR_PATH s3://user-profile-service-locker01/DEV/keycloak-user-spi.jar --sse
          aws s3 cp --content-type='text/plain' $SOURCE_JAR_PATH s3://user-profile-service-locker01/TEST/keycloak-user-spi.jar --sse

      - name: deploy-spi-plugin-prod
        if: "'deploy-spi-plugin-prod' == github.event.inputs.deployment_target"
        env:
          ALLOWED_REFS_PCRE: /^refs\/heads\/release-.*/
          METADATA_FILE_NAME: keycloak01-artifacts.txt
          SOURCE_JAR_PATH: keycloak-user-spi/build/libs/keycloak-user-spi.jar
          AWS_ACCESS_KEY_ID: '${{ secrets.AWS_ACCESS_KEY_ID }}'
          AWS_DEFAULT_REGION: '${{ secrets.AWS_DEFAULT_REGION }}'
          AWS_SECRET_ACCESS_KEY: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
        run: |-
          if [[ -z "${{steps.get-cloned.outputs.REF}}" ]]; then
            echo "::error file=${{github.event.workflow}}::${{github.event.inputs.deployment_target}} refuses to deploy from a non-symbolic ref (commit ${{steps.get-cloned.outputs.SHA}})"
            exit 1
          fi
          if [[ -z $(echo '${{steps.get-cloned.outputs.REF}}' | perl -ne "print if $ALLOWED_REFS_PCRE") ]]; then
            echo "::error file=${{github.event.workflow}}::${{github.event.inputs.deployment_target}} refuses to deploy from '${{steps.get-cloned.outputs.REF}}'"
            exit 1
          fi

          echo 'source file:'
          ls -l $SOURCE_JAR_PATH
          SHA=$(sha256sum $SOURCE_JAR_PATH | awk '{print $1}')
          echo 'SHA='$SHA
          DATE=$(date -ur $SOURCE_JAR_PATH "+%Y%m%d%H%M.%S")
          sed -i 's!sha256!'$SHA'!g' keycloak-user-spi/$METADATA_FILE_NAME
          sed -i 's!datetime!'$DATE'!g' keycloak-user-spi/$METADATA_FILE_NAME
          aws s3 cp keycloak-user-spi/$METADATA_FILE_NAME s3://user-profile-service-locker01/PROD/$METADATA_FILE_NAME --sse
          aws s3 cp --content-type='text/plain' $SOURCE_JAR_PATH s3://user-profile-service-locker01/PROD/keycloak-user-spi.jar --sse
